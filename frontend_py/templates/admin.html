{% extends "base.html" %}

{% block title %}Admin - Transport Schedule Management{% endblock %}

{% block content %}
<h2>Admin Panel</h2>

<ul class="nav nav-tabs" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="stop-tab" data-bs-toggle="tab" data-bs-target="#stop" type="button">
            Manage Stops
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="route-tab" data-bs-toggle="tab" data-bs-target="#route" type="button">
            Manage Routes
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="transport-tab" data-bs-toggle="tab" data-bs-target="#transport" type="button">
            Manage Transport
        </button>
    </li>
</ul>

<div class="tab-content mt-3" id="adminTabContent">
    <!-- Stops Tab -->
    <div class="tab-pane fade show active" id="stop" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Add/Update Stop</h5>
                <form id="stopForm">
                    <div class="mb-3">
                        <label for="stopId" class="form-label">ID (leave empty for new)</label>
                        <input type="number" class="form-control" id="stopId" placeholder="Auto">
                    </div>
                    <div class="mb-3">
                        <label for="stopName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="stopName" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="stopX" class="form-label">X Coordinate *</label>
                            <input type="number" step="0.01" class="form-control" id="stopX" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="stopY" class="form-label">Y Coordinate *</label>
                            <input type="number" step="0.01" class="form-control" id="stopY" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Stop</button>
                </form>
                <div id="stopMessage" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Routes Tab -->
    <div class="tab-pane fade" id="route" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Add/Update Route</h5>
                <form id="routeForm">
                    <div class="mb-3">
                        <label for="routeId" class="form-label">ID (leave empty for new)</label>
                        <input type="number" class="form-control" id="routeId" placeholder="Auto">
                    </div>
                    <div class="mb-3">
                        <label for="routeName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="routeName" required>
                    </div>
                    <div class="mb-3">
                        <label for="routeType" class="form-label">Type *</label>
                        <select class="form-select" id="routeType" required>
                            <option value="bus">Bus</option>
                            <option value="tram">Tram</option>
                            <option value="trolleybus">Trolleybus</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="routeStops" class="form-label">Stop IDs (comma-separated) *</label>
                        <input type="text" class="form-control" id="routeStops" 
                               placeholder="1,2,3,4" required>
                        <small class="form-text text-muted">Enter stop IDs in order, separated by commas</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Route</button>
                </form>
                <div id="routeMessage" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Transport Tab -->
    <div class="tab-pane fade" id="transport" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Add/Update Transport Unit</h5>
                <form id="transportForm">
                    <div class="mb-3">
                        <label for="transportId" class="form-label">ID (leave empty for new)</label>
                        <input type="number" class="form-control" id="transportId" placeholder="Auto">
                    </div>
                    <div class="mb-3">
                        <label for="transportRouteId" class="form-label">Route ID *</label>
                        <input type="number" class="form-control" id="transportRouteId" required>
                    </div>
                    <div class="mb-3">
                        <label for="transportType" class="form-label">Type *</label>
                        <select class="form-select" id="transportType" required>
                            <option value="bus">Bus</option>
                            <option value="tram">Tram</option>
                            <option value="trolleybus">Trolleybus</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transportSpeed" class="form-label">Average Speed (km/h) *</label>
                        <input type="number" step="0.1" class="form-control" id="transportSpeed" required>
                    </div>
                    <div class="mb-3">
                        <label for="transportRouteName" class="form-label">Route Name *</label>
                        <input type="text" class="form-control" id="transportRouteName" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Transport</button>
                </form>
                <div id="transportMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function showMessage(elementId, message, isError = false) {
    const element = document.getElementById(elementId);
    element.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
    element.textContent = message;
    element.style.display = 'block';
    setTimeout(() => {
        element.style.display = 'none';
    }, 3000);
}

// Stop form
document.getElementById('stopForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        name: document.getElementById('stopName').value,
        x: parseFloat(document.getElementById('stopX').value),
        y: parseFloat(document.getElementById('stopY').value)
    };
    const id = document.getElementById('stopId').value;
    if (id) data.id = parseInt(id);
    
    try {
        const response = await fetch('/api/admin/stop', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) {
            showMessage('stopMessage', 'Stop saved successfully!');
            document.getElementById('stopForm').reset();
        } else {
            showMessage('stopMessage', result.message || 'Error saving stop', true);
        }
    } catch (error) {
        showMessage('stopMessage', 'Error: ' + error.message, true);
    }
});

// Route form
document.getElementById('routeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const stopIdsStr = document.getElementById('routeStops').value;
    const stopIds = stopIdsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
    
    const data = {
        name: document.getElementById('routeName').value,
        type: document.getElementById('routeType').value,
        stop_ids: stopIds
    };
    const id = document.getElementById('routeId').value;
    if (id) data.id = parseInt(id);
    
    try {
        const response = await fetch('/api/admin/route', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) {
            showMessage('routeMessage', 'Route saved successfully!');
            document.getElementById('routeForm').reset();
        } else {
            showMessage('routeMessage', result.message || 'Error saving route', true);
        }
    } catch (error) {
        showMessage('routeMessage', 'Error: ' + error.message, true);
    }
});

// Transport form
document.getElementById('transportForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        route_id: parseInt(document.getElementById('transportRouteId').value),
        type: document.getElementById('transportType').value,
        avg_speed: parseFloat(document.getElementById('transportSpeed').value),
        route_name: document.getElementById('transportRouteName').value
    };
    const id = document.getElementById('transportId').value;
    if (id) data.id = parseInt(id);
    
    try {
        const response = await fetch('/api/admin/transport', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) {
            showMessage('transportMessage', 'Transport saved successfully!');
            document.getElementById('transportForm').reset();
        } else {
            showMessage('transportMessage', result.message || 'Error saving transport', true);
        }
    } catch (error) {
        showMessage('transportMessage', 'Error: ' + error.message, true);
    }
});
</script>
{% endblock %}

