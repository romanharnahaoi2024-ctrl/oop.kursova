{% extends "base.html" %}

{% block title %}Map - Transport Schedule Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Live Transport Map</h2>
        <div class="mb-3 d-flex gap-2 flex-wrap">
            <button class="btn btn-primary" onclick="filterVehicles('all')">–í—Å—ñ</button>
            <button class="btn btn-success" onclick="filterVehicles('bus')">–ê–≤—Ç–æ–±—É—Å–∏ üöå</button>
            <button class="btn btn-warning" onclick="filterVehicles('tram')">–¢—Ä–∞–º–≤–∞—ó üöä</button>
            <button class="btn btn-info" onclick="filterVehicles('trolleybus')">–¢—Ä–æ–ª–µ–π–±—É—Å–∏ üöé</button>
            <button id="simStartBtn" class="btn btn-danger" onclick="startSimulation()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
            <button id="simStopBtn" class="btn btn-secondary" onclick="stopSimulation()" style="display:none;">‚è∏ –ó—É–ø–∏–Ω–∏—Ç–∏</button>
            <span id="simStatus" class="badge bg-warning align-self-center">–ó–∞—Ç—Ä–∏–º–∞–Ω–æ</span>
        </div>
        <div id="map" style="height: 600px; width: 100%; border: 1px solid #ccc; border-radius: 8px;"></div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Legend</h5>
                <div class="d-flex gap-3">
                    <span><span class="badge bg-primary">üöå</span> Bus</span>
                    <span><span class="badge bg-success">üöä</span> Tram</span>
                    <span><span class="badge bg-warning">üöé</span> Trolleybus</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="stopModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stopModalTitle">Stop Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="stopModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                <button class="btn btn-primary" id="showScheduleBtn">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// === CONSTANTS ===
const LVIV_LAT = 49.8397;
const LVIV_LON = 24.0297;
const SCALE = 0.005;

// Convert fake model coords ‚Üí real approx map coords
function convertCoord(x, y) {
    return [
        LVIV_LAT + (y - 50) * SCALE,
        LVIV_LON + (x - 50) * SCALE
    ];
}

let map;
let stops = [];
let routes = [];
let stopMarkers = {};
let vehicleMarkers = {};
let currentStopInfo = null;
let simulationRunning = false;
let updateInterval = null;
let lastUpdateTime = 0;
const MIN_UPDATE_INTERVAL = 1000;

// === INIT MAP ===
function initMap() {
    map = L.map('map').setView([LVIV_LAT, LVIV_LON], 15);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; CartoDB'
    }).addTo(map);

    loadStops();
    loadRoutes();
    loadVehicles();
    checkSimulationStatus();
    
    updateInterval = setInterval(updateVehiclePositions, 2000);
}
    

// === LOAD STOPS ===
function loadStops() {
    fetch('/api/stops')
        .then(res => res.json())
        .then(data => {
            stops = data;

            data.forEach(stop => {
                const [lat, lon] = convertCoord(stop.x, stop.y);

                const marker = L.marker([lat, lon])
                    .addTo(map)
                    .on('click', () => showStopInfo(stop));

                stopMarkers[stop.id] = marker;
            });
        });
}


// === LOAD ROUTES ===
function loadRoutes() {
    fetch('/api/routes')
        .then(res => res.json())
        .then(data => {
            routes = data;

            data.forEach(route => {
                if (!route.stop_ids || route.stop_ids.length < 2) return;

                const coords = route.stop_ids
                    .map(id => {
                        const stop = stops.find(s => s.id === id);
                        return stop ? convertCoord(stop.x, stop.y) : null;
                    })
                    .filter(c => c !== null);

                if (coords.length > 1) {
                    const color =
                        route.type === 'bus' ? 'blue' :
                        route.type === 'tram' ? 'green' : 'orange';

                    L.polyline(coords, { color, weight: 3, opacity: 0.7 })
                        .addTo(map);
                }
            });
        });
}


// === LOAD VEHICLES ===
function loadVehicles() {
    fetch('/api/transport')
        .then(res => res.json())
        .then(data => {
            window.vehiclesList = {}; // –≥–ª–æ–±–∞–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ñ–≤

data.forEach(vehicle => {
    const icon = getVehicleIcon(vehicle.type);
  const marker = L.marker([0, 0], { icon }); // –±–µ–∑ .addTo(map)
    vehicleMarkers[vehicle.id] = marker;
    vehiclesList[vehicle.id] = vehicle;
});


            updateVehiclePositions();
        });
}


// === LIVE VEHICLE UPDATE ===
function updateVehiclePositions() {
    const now = Date.now();
    if (now - lastUpdateTime < MIN_UPDATE_INTERVAL) return;
    lastUpdateTime = now;
    
    if (!simulationRunning) return;
    
    fetch('/api/transport/live', { cache: 'no-store' })
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(data => {
            if (!Array.isArray(data) || data.length === 0) return;
            
            data.forEach(pos => {
                const marker = vehicleMarkers[pos.vehicle_id];
                if (!marker) return;

                vehiclesList[pos.vehicle_id].type = pos.type;
                const [lat, lon] = convertCoord(pos.x, pos.y);
                marker.setLatLng([lat, lon]);
                marker.setIcon(getVehicleIcon(pos.type));
            });
        })
        .catch(err => console.log('Update error:', err));
}

// === –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –°–ò–ú–£–õ–Ø–¶–Ü–Ñ–Æ ===
function startSimulation() {
    fetch('/api/simulation/control', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'start' })
    })
    .then(res => res.json())
    .then(() => {
        simulationRunning = true;
        updateSimulationUI();
    })
    .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', err));
}

function stopSimulation() {
    fetch('/api/simulation/control', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'stop' })
    })
    .then(res => res.json())
    .then(() => {
        simulationRunning = false;
        updateSimulationUI();
    })
    .catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', err));
}

function updateSimulationUI() {
    const startBtn = document.getElementById('simStartBtn');
    const stopBtn = document.getElementById('simStopBtn');
    const statusBadge = document.getElementById('simStatus');
    
    if (simulationRunning) {
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        statusBadge.textContent = '‚ñ∂ –ü—Ä–∞—Ü—é—î';
        statusBadge.className = 'badge bg-success';
    } else {
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        statusBadge.textContent = '‚è∏ –ó–∞—Ç—Ä–∏–º–∞–Ω–æ';
        statusBadge.className = 'badge bg-warning';
    }
}

function checkSimulationStatus() {
    fetch('/api/simulation/status')
        .then(res => res.json())
        .then(data => {
            simulationRunning = data.running || false;
            updateSimulationUI();
        })
        .catch(() => {
            simulationRunning = false;
            updateSimulationUI();
        });
}



// === VEHICLE ICON ===
function getVehicleIcon(type) {
    const symbol = type === 'bus' ? 'üöå'
        : type === 'tram' ? 'üöä'
        : 'üöé';

    return L.divIcon({
        className: 'vehicle-icon',
        html: `<div style="font-size: 26px;">${symbol}</div>`,
        iconSize: [30, 30]
    });
}


// === STOP INFO MODAL ===
function showStopInfo(stop) {
    currentStopInfo = stop;

    const serving = routes.filter(r => r.stop_ids.includes(stop.id));

    let html = `
        <h5>${stop.name}</h5>
        <p><b>Coordinates:</b> (${stop.x}, ${stop.y})</p>
        <b>Serving routes:</b>
        <ul>
    `;

    serving.forEach(r => html += `<li>${r.name} (${r.type})</li>`);
    html += "</ul>";

    document.getElementById("stopModalBody").innerHTML = html;
    document.getElementById("stopModalTitle").textContent = stop.name;

    new bootstrap.Modal(document.getElementById('stopModal')).show();
}

document.getElementById("showScheduleBtn").addEventListener("click", () => {
    if (currentStopInfo) {
        window.location.href = `/routes?stop=${currentStopInfo.id}`;
    }
});

function filterVehicles(type) {
    for (const id in vehicleMarkers) {
        const marker = vehicleMarkers[id];
        const vehicle = vehiclesList[id];

        if (type === "all" || vehicle.type === type) {
            map.addLayer(marker);  // –ø–æ–∫–∞–∑–∞—Ç–∏
        } else {
            map.removeLayer(marker);  // —Å—Ö–æ–≤–∞—Ç–∏
        }
    }
}



// === START ===
document.addEventListener('DOMContentLoaded', initMap);

window.addEventListener('beforeunload', () => {
    if (updateInterval) clearInterval(updateInterval);
});
</script>
{% endblock %}
